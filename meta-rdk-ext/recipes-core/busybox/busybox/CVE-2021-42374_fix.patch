Date: Dec 2, 2023
From: srihariraghava_konduritirumala@comcast.com
Source: upstream
        https://git.busybox.net/busybox/commit/?id=04f052c56ded5ab6a904e3a264a73dc0412b2e78
Index: busybox-1.31.1/archival/libarchive/decompress_unlzma.c
===================================================================
--- busybox-1.31.1.orig/archival/libarchive/decompress_unlzma.c
+++ busybox-1.31.1/archival/libarchive/decompress_unlzma.c
@@ -290,8 +290,11 @@ unpack_lzma_stream(transformer_state_t *
 				uint32_t pos;
 
 				pos = buffer_pos - rep0;
-				if ((int32_t)pos < 0)
+                if ((int32_t)pos < 0) {
 					pos += header.dict_size;
+                    if ((int32_t)pos < 0)
+                            goto bad;
+                }
 				match_byte = buffer[pos];
 				do {
 					int bit;
Index: busybox-1.31.1/testsuite/unlzma_issue_3.lzma
===================================================================
--- /dev/null
+++ busybox-1.31.1/testsuite/unlzma_issue_3.lzma
@@ -0,0 +1 @@
+
Index: busybox-1.31.1/testsuite/unlzma.tests
===================================================================
--- busybox-1.31.1.orig/testsuite/unlzma.tests
+++ busybox-1.31.1/testsuite/unlzma.tests
@@ -8,14 +8,23 @@
 
 # Damaged encrypted streams
 testing "unlzma (bad archive 1)" \
-	"unlzma <unlzma_issue_1.lzma >/dev/null; echo \$?" \
-"1
+      "unlzma <unlzma_issue_1.lzma 2>&1 >/dev/null; echo \$?" \
+"unlzma: corrupted data
+1
 " "" ""
 
 # Damaged encrypted streams
 testing "unlzma (bad archive 2)" \
-	"unlzma <unlzma_issue_2.lzma >/dev/null; echo \$?" \
-"1
+      "unlzma <unlzma_issue_2.lzma 2>&1 >/dev/null; echo \$?" \
+"unlzma: corrupted data
+1
+" "" ""
+
+# Damaged encrypted streams
+testing "unlzma (bad archive 3)" \
+      "unlzma <unlzma_issue_3.lzma 2>&1 >/dev/null; echo \$?" \
+"unlzma: corrupted data
+1
 " "" ""
 
 exit $FAILCOUNT
